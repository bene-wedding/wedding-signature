<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>BENE Wedding Project</title>

<!-- ฟอนต์ -->
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">

<style>
    body {
        font-family: 'Sarabun', sans-serif;
        background: #fafafa;
        margin: 0;
        padding: 0;
    }

    #title {
        text-align: center;
        font-size: 36px;
        font-weight: 600;
        margin-top: 20px;
        color: #5a3e2b;
    }

    #subtitle {
        text-align: center;
        font-size: 16px;
        margin-bottom: 20px;
        color: #888;
    }

    #canvas_div {
        text-align: center;
        display: block;
        margin-left: auto;
        margin-right: auto;
        overflow-x: auto;
    }

    canvas {
        border: 2px solid black;
        background: white;
        touch-action: none; /* สำคัญมากสำหรับ iPad */
    }

    .tools {
        margin-top: 10px;
    }

    button, select {
        font-size: 16px;
        padding: 6px 10px;
        margin: 4px;
    }
</style>
</head>

<body>

<!-- ===== TITLE ===== -->
<div id="title">BENE Wedding Project</div>
<div id="subtitle">เขียนคำอวยพรให้บ่าวสาวด้วยลายมือของคุณ</div>

<!-- ===== CANVAS ===== -->
<div id="canvas_div">
    <canvas id="canvas" width="900" height="640"></canvas>

    <div class="tools">
        <button onclick="clearArea()">Clear Area</button>

        Line width :
        <select id="selWidth">
            <option value="8" selected>8</option>
            <option value="10">10</option>
            <option value="13">13</option>
            <option value="15">15</option>
        </select>

        Color :
        <select id="selColor">
            <option value="black">black</option>
            <option value="blue" selected>blue</option>
            <option value="red">red</option>
            <option value="magenta">magenta</option>
            <option value="green">green</option>
            <option value="yellow">yellow</option>
            <option value="gray">gray</option>
        </select>

        <button onclick="saveCanvas()">Send</button>
    </div>
</div>

<!-- ===== JS ===== -->
<script>
const canvas = document.getElementById('canvas');
const context = canvas.getContext('2d');

let isDrawing = false;
let x = 0;
let y = 0;
let offsetX = 0;
let offsetY = 0;
const ongoingTouches = [];

/* ---------- STARTUP ---------- */
function startup() {
    canvas.addEventListener('touchstart', handleStart);
    canvas.addEventListener('touchend', handleEnd);
    canvas.addEventListener('touchcancel', handleCancel);
    canvas.addEventListener('touchmove', handleMove);

    canvas.addEventListener('mousedown', (e) => {
        x = e.offsetX;
        y = e.offsetY;
        isDrawing = true;
    });

    canvas.addEventListener('mousemove', (e) => {
        if (isDrawing) {
            drawLine(context, x, y, e.offsetX, e.offsetY);
            x = e.offsetX;
            y = e.offsetY;
        }
    });

    canvas.addEventListener('mouseup', (e) => {
        if (isDrawing) {
            drawLine(context, x, y, e.offsetX, e.offsetY);
            isDrawing = false;
        }
    });
}

document.addEventListener("DOMContentLoaded", startup);

/* ---------- TOUCH ---------- */
function handleStart(evt) {
    evt.preventDefault();
    const touches = evt.changedTouches;
    const rect = canvas.getBoundingClientRect();
    offsetX = rect.left;
    offsetY = rect.top;

    for (let i = 0; i < touches.length; i++) {
        ongoingTouches.push(copyTouch(touches[i]));
    }
}

function handleMove(evt) {
    evt.preventDefault();
    const touches = evt.changedTouches;

    for (let i = 0; i < touches.length; i++) {
        const idx = ongoingTouchIndexById(touches[i].identifier);
        if (idx >= 0) {
            context.beginPath();
            context.moveTo(
                ongoingTouches[idx].clientX - offsetX,
                ongoingTouches[idx].clientY - offsetY
            );
            context.lineTo(
                touches[i].clientX - offsetX,
                touches[i].clientY - offsetY
            );
            context.strokeStyle = selColor.value;
            context.lineWidth = selWidth.value;
            context.lineJoin = "round";
            context.stroke();

            ongoingTouches.splice(idx, 1, copyTouch(touches[i]));
        }
    }
}

function handleEnd(evt) {
    evt.preventDefault();
    const touches = evt.changedTouches;
    for (let i = 0; i < touches.length; i++) {
        const idx = ongoingTouchIndexById(touches[i].identifier);
        if (idx >= 0) ongoingTouches.splice(idx, 1);
    }
}

function handleCancel(evt) {
    evt.preventDefault();
    ongoingTouches.length = 0;
}

function copyTouch(touch) {
    return {
        identifier: touch.identifier,
        clientX: touch.clientX,
        clientY: touch.clientY
    };
}

function ongoingTouchIndexById(id) {
    for (let i = 0; i < ongoingTouches.length; i++) {
        if (ongoingTouches[i].identifier === id) return i;
    }
    return -1;
}

/* ---------- DRAW ---------- */
function drawLine(ctx, x1, y1, x2, y2) {
    ctx.beginPath();
    ctx.strokeStyle = selColor.value;
    ctx.lineWidth = selWidth.value;
    ctx.lineJoin = "round";
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
}

/* ---------- CLEAR ---------- */
function clearArea() {
    context.clearRect(0, 0, canvas.width, canvas.height);
}

/* ---------- SAVE ---------- */
function saveCanvas() {
    const image = canvas.toDataURL("image/png");

    // ดึงของเก่า
    let list = JSON.parse(localStorage.getItem("weddingSignatures")) || [];

    // เพิ่มรูปใหม่
    list.push({
        img: image,
        time: new Date().toLocaleString()
    });

    // เซฟกลับ
    localStorage.setItem("weddingSignatures", JSON.stringify(list));

    // รูปล่าสุดไว้โชว์จอใหญ่
    localStorage.setItem("weddingImage", image);

    alert("บันทึกลายเซ็นเรียบร้อย ✍️");
    clearArea();
}


</script>

</body>
</html>
